<?php
session_start();
include '../Guest/Connect.php'; // ÚˆÛŒÙ¹Ø§ Ø¨ÛŒØ³ Ú©Ù†Ú©Ø´Ù†

// Ú†ÛŒÚ© Ú©Ø±ÛŒÚº Ú©Û ÙØ§Ø±Ù… Ø³Ø¨Ù…Ù¹ ÛÙˆØ§ ÛÛ’ ÛŒØ§ Ù†ÛÛŒÚº
if ($_SERVER["REQUEST_METHOD"] == "POST") {

    if (!isset($_SESSION['user_id'])) {
        echo "Please login to generate a bill. <a href='index.html'>Login here</a>.";
        exit();
    }

    // ÙØ§Ø±Ù… Ú©Û’ ÚˆÛŒÙ¹Ø§ Ú©Ùˆ Ø­Ø§ØµÙ„ Ú©Ø±ÛŒÚº
    $booking_id = trim($_POST['bookingId']);
    $guest_id = trim($_POST['guestId']);
    $guest_name = trim($_POST['guestName']);
    $room_type = trim($_POST['roomType']);
    $room_price = trim($_POST['roomPrice']);
    $nights = trim($_POST['nights']);
    $extra_charges = trim($_POST['extraCharges']);
    $total_amount = trim($_POST['totalAmount']);
    $billing_date = trim($_POST['billingDate']);

    // Ú†ÛŒÚ© Ú©Ø±ÛŒÚº Ú©Û Ø¶Ø±ÙˆØ±ÛŒ ÙÛŒÙ„ÚˆØ² Ø®Ø§Ù„ÛŒ Ù†Û ÛÙˆÚº
    if (empty($booking_id) || empty($guest_id) || empty($guest_name) || empty($room_type) || empty($room_price) || empty($nights) || empty($total_amount) || empty($billing_date)) {
        echo "All fields are required!";
        exit();
    }

    // ðŸ”¹ Booking ID Ú©Ùˆ Ú†ÛŒÚ© Ú©Ø±ÛŒÚº
    $checkBooking = $conn->prepare("SELECT id FROM bookings WHERE id = ?");
    $checkBooking->bind_param("i", $booking_id);
    $checkBooking->execute();
    $checkBooking->store_result();

    if ($checkBooking->num_rows == 0) {
        die("Error: Booking ID does not exist in bookings table.");
    }
    $checkBooking->close();

    // ðŸ”¹ Guest ID Ú©Ùˆ Ú†ÛŒÚ© Ú©Ø±ÛŒÚº
    $checkGuest = $conn->prepare("SELECT guest_id FROM guests WHERE guest_id = ?");
    $checkGuest->bind_param("i", $guest_id);
    $checkGuest->execute();
    $checkGuest->store_result();

    if ($checkGuest->num_rows == 0) {
        die("Error: Guest ID does not exist in guests table.");
    }
    $checkGuest->close();

    // SQL Ú©Ùˆ ØªÛŒØ§Ø± Ú©Ø±ÛŒÚº
    $stmt = $conn->prepare("INSERT INTO billing (booking_id, guest_id, guest_name, room_type, room_price, nights, extra_charges, total_amount, billing_date) 
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)");

    $stmt->bind_param("iissdidds", $booking_id, $guest_id, $guest_name, $room_type, $room_price, $nights, $extra_charges, $total_amount, $billing_date);

    // SQL Ú©Ùˆ Ø§ÛŒÚ©Ø²ÛŒÚ©ÛŒÙˆÙ¹ Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ú†ÛŒÚ© Ú©Ø±ÛŒÚº Ú©Û Ú©Ø§Ù…ÛŒØ§Ø¨ ÛÙˆØ§ ÛŒØ§ Ù†ÛÛŒÚº
    if ($stmt->execute()) {
        echo "Bill generated successfully!";
    } else {
        echo "Error generating bill: " . $stmt->error;
    }

    $stmt->close();
    $conn->close();
}
?>
